<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ æ–™ - å››æ—¶</title>
    <style>
        @font-face {
            font-family: 'ShuQingGuKaiTi';
            src: url('../assets/ShuQingGuKaiTi-2.ttf') format('truetype');
            font-display: swap;
        }
        html, body, * {
            font-family: 'ShuQingGuKaiTi', serif !important;
        }
        
        :root {
            --primary-red: #60281E;
            --secondary-gold: #DAA520;
            --accent-jade: #478778;
            --warm-beige: #F5F5DC;
            --ink-black: #2C2C2C;
            --paper-white: #FEFEFE;
            --border-gray: #D3D3D3;
            --shadow-dark: rgba(44, 44, 44, 0.2);
            --success-green: #52C41A;
            --warning-orange: #FA8C16;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Serif SC', serif;
            background: linear-gradient(135deg, var(--warm-beige) 0%, var(--paper-white) 100%);
            color: var(--ink-black);
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
            min-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
        }

        .back-button {
            padding: 0.8rem 1.5rem;
            background: var(--accent-jade);
            color: var(--paper-white);
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 2px solid var(--accent-jade);
        }

        .back-button:hover {
            background: transparent;
            color: var(--accent-jade);
            transform: translateY(-2px);
        }

        .location-info {
            background: var(--secondary-gold);
            color: var(--paper-white);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .title-section {
            text-align: center;
            margin-bottom: 3rem;
        }

        .dumpling-icon {
            background: url('../assets/3.png') no-repeat center center / contain !important;
            border-radius: 0;
            position: relative;
        }
        .dumpling-icon::after {
            content: none !important;
        }

        .page-title {
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary-red);
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px var(--shadow-dark);
        }

        .page-subtitle {
            font-size: 1.2rem;
            color: var(--accent-jade);
            font-weight: 400;
        }

        .ingredients-section {
            background: var(--paper-white);
            border: 3px solid var(--border-gray);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 4px 4px 12px var(--shadow-dark);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-red);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .common-ingredients {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .ingredient-item {
            background: var(--warm-beige);
            border: 2px solid var(--border-gray);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        .ingredient-item:hover {
            transform: translateY(-4px);
            border-color: var(--secondary-gold);
            box-shadow: 0 4px 12px var(--shadow-dark);
        }

        .ingredient-item.selected {
            background: var(--secondary-gold);
            color: var(--paper-white);
            border-color: var(--secondary-gold);
        }

        .ingredient-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .ingredient-name {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .custom-ingredient {
            margin-top: 1rem;
        }

        .custom-input {
            width: 100%;
            padding: 1rem;
            font-size: 1rem;
            border: 2px solid var(--border-gray);
            border-radius: 8px;
            background: var(--paper-white);
            color: var(--ink-black);
            font-family: 'Noto Serif SC', serif;
            transition: all 0.3s ease;
        }

        .custom-input:focus {
            outline: none;
            border-color: var(--secondary-gold);
            box-shadow: 0 0 8px rgba(218, 165, 32, 0.3);
        }

        .voice-section {
            background: var(--paper-white);
            border: 3px solid var(--border-gray);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 4px 4px 12px var(--shadow-dark);
        }

        .voice-controls {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .voice-button {
            padding: 1rem 2rem;
            font-size: 1.1rem;
            border: 3px solid var(--border-gray);
            border-radius: 12px;
            background: var(--paper-white);
            color: var(--ink-black);
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Noto Serif SC', serif;
            font-weight: 500;
            min-width: 120px;
        }

        .voice-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-dark);
        }

        .voice-button.start {
            border-color: var(--success-green);
            color: var(--success-green);
        }

        .voice-button.start:hover, .voice-button.start.active {
            background: var(--success-green);
            color: var(--paper-white);
        }

        .voice-button.stop {
            border-color: var(--primary-red);
            color: var(--primary-red);
        }

        .voice-button.stop:hover, .voice-button.stop.active {
            background: var(--primary-red);
            color: var(--paper-white);
        }

        .voice-status {
            text-align: center;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 500;
            min-height: 1.5rem;
        }

        .voice-status.listening {
            color: var(--success-green);
        }

        .voice-status.processing {
            color: var(--warning-orange);
        }

        .voice-status.success {
            color: var(--success-green);
        }

        .voice-status.error {
            color: var(--primary-red);
        }

        .voice-result {
            background: var(--warm-beige);
            border: 2px solid var(--border-gray);
            border-radius: 8px;
            padding: 1rem;
            min-height: 100px;
            font-size: 1rem;
            line-height: 1.5;
        }

        .warehouse-summary {
            background: var(--accent-jade);
            color: var(--paper-white);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
            text-align: center;
        }

        .warehouse-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .warehouse-content {
            font-size: 1rem;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .page-title {
                font-size: 2.5rem;
            }
            
            .common-ingredients {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }
            
            .voice-controls {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="../index.html" class="back-button">â† è¿”å›é¦–é¡µ</a>
            <div class="location-info" id="locationInfo">æŒªå¨</div>
        </div>

        <div class="title-section">
            <div class="dumpling-icon"></div>
            <h1 class="page-title">åŠ æ–™</h1>
            <p class="page-subtitle">ç®¡ç†æ‚¨çš„è°ƒæ–™ä»“åº“</p>
        </div>

        <div class="ingredients-section">
            <h2 class="section-title">ä¸­é¤å¸¸è§è°ƒæ–™</h2>
            <div class="common-ingredients">
                <div class="ingredient-item" onclick="toggleIngredient(this, 'ç›')">
                    <div class="ingredient-icon" style="background: url('../assets/7.png') no-repeat center center / contain; width: 80px; height: 80px; margin: 0 auto 0.5rem; display: block;"></div>
                    <div class="ingredient-name">ç›</div>
                </div>
                <div class="ingredient-item" onclick="toggleIngredient(this, 'ç³–')">
                    <div class="ingredient-icon" style="background: url('../assets/8.png') no-repeat center center / contain; width: 80px; height: 80px; margin: 0 auto 0.5rem; display: block;"></div>
                    <div class="ingredient-name">ç³–</div>
                </div>
                <div class="ingredient-item" onclick="toggleIngredient(this, 'é†‹')">
                    <div class="ingredient-icon" style="background: url('../assets/9.png') no-repeat center center / contain; width: 80px; height: 80px; margin: 0 auto 0.5rem; display: block;"></div>
                    <div class="ingredient-name">é†‹</div>
                </div>
                <div class="ingredient-item" onclick="toggleIngredient(this, 'é…±æ²¹')">
                    <div class="ingredient-icon" style="background: url('../assets/10.png') no-repeat center center / contain; width: 80px; height: 80px; margin: 0 auto 0.5rem; display: block;"></div>
                    <div class="ingredient-name">é…±æ²¹</div>
                </div>
                <div class="ingredient-item" onclick="toggleIngredient(this, 'æ–™é…’')">
                    <div class="ingredient-icon" style="background: url('../assets/11.png') no-repeat center center / contain; width: 80px; height: 80px; margin: 0 auto 0.5rem; display: block;"></div>
                    <div class="ingredient-name">æ–™é…’</div>
                </div>
            </div>
            
            <div class="custom-ingredient">
                <input type="text" class="custom-input" placeholder="è¾“å…¥å…¶ä»–è°ƒæ–™åç§°..." 
                       onkeypress="handleCustomIngredient(event)">
            </div>
        </div>

        <div class="voice-section">
            <h2 class="section-title">è¯­éŸ³è¾“å…¥ä»“åº“ç®¡ç†</h2>
            <div class="voice-controls">
                <button class="voice-button start" onclick="startVoiceInput()">å¼€å§‹</button>
                <button class="voice-button stop" onclick="stopVoiceInput()">ç»“æŸ</button>
            </div>
            <div class="voice-status" id="voiceStatus">ç‚¹å‡»"å¼€å§‹"æŒ‰é’®å¼€å§‹è¯­éŸ³è¾“å…¥</div>
            <div class="voice-result" id="voiceResult">
                è¯­éŸ³è¯†åˆ«ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º...
                <br><br>
                ä¾‹å¦‚ï¼šè¯´ "æˆ‘æœ‰ä¸‰ä¸ªè¥¿çº¢æŸ¿ï¼Œä¸¤æ ¹é»„ç“œï¼Œä¸€åŒ…é¢æ¡" 
                <br>
                ç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«å¹¶æ·»åŠ åˆ°æ‚¨çš„ä»“åº“ä¸­
                <br><br>
                <strong>æ”¯æŒæ ¼å¼ï¼š</strong>
                <br>
                â€¢ ä¸­æ–‡æ•°å­—ï¼šä¸‰ä¸ªè¥¿çº¢æŸ¿ã€ä¸¤æ ¹é»„ç“œ
                <br>
                â€¢ é˜¿æ‹‰ä¼¯æ•°å­—ï¼š3ä¸ªè¥¿çº¢æŸ¿ã€2æ ¹é»„ç“œ
                <br>
                â€¢ å•ä½ï¼šä¸ªã€æ ¹ã€åŒ…ã€å—ã€ç“¶ã€è¢‹ã€æ–¤ç­‰
            </div>
        </div>

        <div class="warehouse-summary">
            <div class="warehouse-title">
                æˆ‘çš„è°ƒæ–™ä»“åº“
                <button onclick="clearAllIngredients()" class="clear-button" style="float: right; padding: 0.3rem 0.8rem; background: #C7302B; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">æ¸…ç©ºä»“åº“</button>
            </div>
            <div class="warehouse-content" id="warehouseContent">
                ä»“åº“ä¸ºç©ºï¼Œè¯·æ·»åŠ è°ƒæ–™...
            </div>
        </div>

        <!-- æµ‹è¯•åŒºåŸŸï¼ˆä»…åœ¨å¼€å‘ç¯å¢ƒæ˜¾ç¤ºï¼‰ -->
        <div id="testArea" style="display: none; margin-top: 2rem; padding: 1rem; background: #f0f0f0; border-radius: 8px;">
            <h3>åŒä¹‰è¯æµ‹è¯•åŒºåŸŸ</h3>
            <p>æµ‹è¯•è¾“å…¥ï¼š</p>
            <input type="text" id="testInput" placeholder="è¾“å…¥æµ‹è¯•æ–‡æœ¬ï¼Œå¦‚ï¼šä¸‰ä¸ªè¥¿çº¢æŸ¿ï¼Œä¸¤ä¸ªç•ªèŒ„" style="width: 100%; padding: 0.5rem; margin-bottom: 1rem;">
            <button onclick="runTest()" style="padding: 0.5rem 1rem; background: #478778; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 1rem;">è¿è¡Œæµ‹è¯•</button>
            <button onclick="testClearAll()" style="padding: 0.5rem 1rem; background: #C7302B; color: white; border: none; border-radius: 4px; cursor: pointer;">æµ‹è¯•æ¸…ç©ºåŠŸèƒ½</button>
            <div id="testResult" style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 4px;"></div>
        </div>
        
        <!-- æœ¬åœ°è¯­éŸ³è¯†åˆ«æµ‹è¯•åŒºåŸŸ -->
        <div id="localVoiceTest" style="display: none; margin-top: 2rem; padding: 1rem; background: #e8f5e8; border-radius: 8px; border: 2px solid #478778;">
            <h3>ğŸ§ª æœ¬åœ°è¯­éŸ³è¯†åˆ«æµ‹è¯•</h3>
            <p>åœ¨é™æ€éƒ¨ç½²ç¯å¢ƒä¸‹ï¼Œè¯­éŸ³è¯†åˆ«åŠŸèƒ½ä¼šä½¿ç”¨æœ¬åœ°æ¨¡æ‹Ÿã€‚ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®æµ‹è¯•æœ¬åœ°è¯­éŸ³è¯†åˆ«åŠŸèƒ½ï¼š</p>
            <button onclick="testLocalVoiceRecognition()" style="padding: 0.8rem 1.5rem; background: #478778; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; margin-right: 1rem;">æµ‹è¯•æœ¬åœ°è¯­éŸ³è¯†åˆ«</button>
            <button onclick="clearVoiceTestResult()" style="padding: 0.8rem 1.5rem; background: #C7302B; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem;">æ¸…ç©ºæµ‹è¯•ç»“æœ</button>
            <div id="localVoiceTestResult" style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 6px; border: 1px solid #ddd;"></div>
        </div>
    </div>

    <script src="api-utils.js"></script>
    <script>
        let selectedIngredients = []; // å­˜å‚¨é£Ÿæåç§°
        let ingredientQuantities = {}; // å­˜å‚¨é£Ÿææ•°é‡
        let isListening = false;

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºç”¨æˆ·ä½ç½®å’Œæ¢å¤ä»“åº“æ•°æ®
        window.addEventListener('load', async function() {
            const savedLocation = await api.getUserLocation();
            const locationInfo = document.getElementById('locationInfo');
            
            if (savedLocation) {
                const locationNames = {
                    'norway': 'æŒªå¨',
                    'sweden': 'ç‘å…¸',
                    'denmark': 'ä¸¹éº¦',
                    'finland': 'èŠ¬å…°',
                    'iceland': 'å†°å²›',
                    'germany': 'å¾·å›½',
                    'netherlands': 'è·å…°',
                    'france': 'æ³•å›½',
                    'uk': 'è‹±å›½',
                    'other': 'æ¬§æ´²'
                };
                locationInfo.textContent = locationNames[savedLocation] || 'æœªçŸ¥ä½ç½®';
            }

            // æ¢å¤å·²é€‰æ‹©çš„è°ƒæ–™
            await loadSavedIngredients();
        });

        function toggleIngredient(element, ingredientName) {
            element.classList.toggle('selected');
            
            // æ ‡å‡†åŒ–é£Ÿæåç§°
            const normalizedName = normalizeIngredientName(ingredientName);
            
            if (element.classList.contains('selected')) {
                if (!selectedIngredients.includes(normalizedName)) {
                    selectedIngredients.push(normalizedName);
                    ingredientQuantities[normalizedName] = '1ä¸ª'; // é»˜è®¤æ•°é‡
                }
            } else {
                selectedIngredients = selectedIngredients.filter(item => item !== normalizedName);
                delete ingredientQuantities[normalizedName]; // åˆ é™¤æ•°é‡è®°å½•
            }
            
            updateWarehouseDisplay();
            saveToLocalStorage();
        }

        function handleCustomIngredient(event) {
            if (event.key === 'Enter') {
                const ingredientName = event.target.value.trim();
                if (ingredientName) {
                    // æ ‡å‡†åŒ–é£Ÿæåç§°
                    const normalizedName = normalizeIngredientName(ingredientName);
                    if (!selectedIngredients.includes(normalizedName)) {
                        selectedIngredients.push(normalizedName);
                        ingredientQuantities[normalizedName] = '1ä¸ª'; // é»˜è®¤æ•°é‡
                        updateWarehouseDisplay();
                        saveToLocalStorage();
                        event.target.value = '';
                    }
                }
            }
        }

        let mediaRecorder = null;
        let audioChunks = [];

        async function startVoiceInput() {
            if (isListening) return;
            
            try {
                // è¯·æ±‚éº¦å…‹é£æƒé™ï¼Œä½¿ç”¨æ›´é€‚åˆè¯­éŸ³è¯†åˆ«çš„éŸ³é¢‘è®¾ç½®
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                isListening = true;
                const statusElement = document.getElementById('voiceStatus');
                const startButton = document.querySelector('.voice-button.start');
                
                statusElement.textContent = 'æ­£åœ¨ç›‘å¬ä¸­...';
                statusElement.className = 'voice-status listening';
                startButton.classList.add('active');
                
                // åˆ›å»ºMediaRecorderï¼Œä½¿ç”¨æ›´å¥½çš„éŸ³é¢‘æ ¼å¼
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    
                    // æ£€æŸ¥éŸ³é¢‘è´¨é‡
                    if (audioChunks.length === 0) {
                        const statusElement = document.getElementById('voiceStatus');
                        statusElement.textContent = 'å½•éŸ³æ—¶é—´å¤ªçŸ­ï¼Œè¯·é‡æ–°å½•éŸ³';
                        statusElement.className = 'voice-status error';
                        stream.getTracks().forEach(track => track.stop());
                        return;
                    }
                    
                    // è½¬æ¢ä¸ºç™¾åº¦APIè¦æ±‚çš„æ ¼å¼
                    const convertedBlob = await convertAudioForBaiduAPI(audioBlob);
                    await processVoiceRecognition(convertedBlob);
                    
                    // åœæ­¢æ‰€æœ‰éŸ³é¢‘è½¨é“
                    stream.getTracks().forEach(track => track.stop());
                };
                
                // å¼€å§‹å½•éŸ³
                mediaRecorder.start();
                
            } catch (error) {
                console.error('å¯åŠ¨è¯­éŸ³è¯†åˆ«å¤±è´¥:', error);
                const statusElement = document.getElementById('voiceStatus');
                statusElement.textContent = 'æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®';
                statusElement.className = 'voice-status error';
            }
        }

        function stopVoiceInput() {
            if (!isListening || !mediaRecorder) return;
            
            isListening = false;
            const statusElement = document.getElementById('voiceStatus');
            const startButton = document.querySelector('.voice-button.start');
            const stopButton = document.querySelector('.voice-button.stop');
            
            statusElement.textContent = 'æ­£åœ¨å¤„ç†è¯­éŸ³...';
            statusElement.className = 'voice-status processing';
            startButton.classList.remove('active');
            stopButton.classList.add('active');
            
            // åœæ­¢å½•éŸ³
            mediaRecorder.stop();
            
            setTimeout(() => {
                stopButton.classList.remove('active');
            }, 1000);
        }

        async function processVoiceRecognition(audioBlob) {
            try {
                const statusElement = document.getElementById('voiceStatus');
                const resultElement = document.getElementById('voiceResult');
                
                statusElement.textContent = 'æ­£åœ¨è¯†åˆ«è¯­éŸ³...';
                statusElement.className = 'voice-status processing';
                
                // è°ƒç”¨è¯­éŸ³è¯†åˆ«API
                const result = await api.recognizeVoice(audioBlob);
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                const recognizedText = result.text;
                
                // å¦‚æœæ˜¯æœ¬åœ°æ¨¡æ‹Ÿï¼Œæ˜¾ç¤ºæç¤º
                if (result.source === 'local_simulation') {
                    console.log('ä½¿ç”¨æœ¬åœ°è¯­éŸ³è¯†åˆ«æ¨¡æ‹Ÿ');
                }
                
                // è§£æé£Ÿæå’Œæ•°é‡
                const parsedIngredients = parseIngredientsFromText(recognizedText);
                
                // æ˜¾ç¤ºè¯†åˆ«ç»“æœ
                resultElement.innerHTML = `
                    <strong>è¯†åˆ«ç»“æœï¼š</strong>${recognizedText}
                    <br><br>
                    <strong>è§£æç»“æœï¼š</strong>
                    <br>
                    ${parsedIngredients.map(item => `${item.name}ï¼š${item.quantity}`).join('ã€')}
                `;
                
                // æ·»åŠ åˆ°ä»“åº“
                parsedIngredients.forEach(item => {
                    const ingredientName = item.name;
                    if (!selectedIngredients.includes(ingredientName)) {
                        selectedIngredients.push(ingredientName);
                    }
                    
                    // ç´¯åŠ æ•°é‡è€Œä¸æ˜¯è¦†ç›–
                    const currentQuantity = ingredientQuantities[ingredientName] || '0ä¸ª';
                    const newQuantity = item.quantity;
                    
                    // è§£æå½“å‰æ•°é‡å’Œæ–°æ•°é‡
                    const currentNum = parseInt(currentQuantity.match(/\d+/)[0]) || 0;
                    const newNum = parseInt(newQuantity.match(/\d+/)[0]) || 0;
                    
                    // æå–å•ä½ï¼Œä¼˜å…ˆä½¿ç”¨æ–°æ•°é‡çš„å•ä½
                    let unit = 'ä¸ª';
                    const unitMatch = newQuantity.match(/[ä¸ªåŒ…æ ¹ç“¶è¢‹æ–¤å…‹åƒå…‹å…¬æ–¤ç‰‡ç“£æŠŠæŸç›’]/);
                    if (unitMatch) {
                        unit = unitMatch[0];
                    } else {
                        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å•ä½ï¼Œå°è¯•ä»å½“å‰æ•°é‡ä¸­æå–
                        const currentUnitMatch = currentQuantity.match(/[ä¸ªåŒ…æ ¹ç“¶è¢‹æ–¤å…‹åƒå…‹å…¬æ–¤ç‰‡ç“£æŠŠæŸç›’]/);
                        if (currentUnitMatch) {
                            unit = currentUnitMatch[0];
                        }
                    }
                    
                    // ç´¯åŠ æ•°é‡
                    const totalNum = currentNum + newNum;
                    ingredientQuantities[ingredientName] = `${totalNum}${unit}`;
                });
                
                updateWarehouseDisplay();
                saveToLocalStorage();
                
                statusElement.textContent = 'è¯­éŸ³è¯†åˆ«å®Œæˆ';
                statusElement.className = 'voice-status success';
                
                setTimeout(() => {
                    statusElement.textContent = 'ç‚¹å‡»"å¼€å§‹"æŒ‰é’®å¼€å§‹è¯­éŸ³è¾“å…¥';
                    statusElement.className = 'voice-status';
                }, 3000);
                
            } catch (error) {
                console.error('è¯­éŸ³è¯†åˆ«å¤±è´¥:', error);
                const statusElement = document.getElementById('voiceStatus');
                const resultElement = document.getElementById('voiceResult');
                
                statusElement.textContent = 'è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•';
                statusElement.className = 'voice-status error';
                
                resultElement.innerHTML = `
                    <strong>è¯†åˆ«å¤±è´¥ï¼š</strong>${error.message}
                    <br><br>
                    è¯·æ£€æŸ¥ï¼š
                    <br>
                    1. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
                    <br>
                    2. è¯­éŸ³æ˜¯å¦æ¸…æ™°
                    <br>
                    3. ç™¾åº¦APIå¯†é’¥æ˜¯å¦é…ç½®æ­£ç¡®
                    <br><br>
                    <strong>æç¤ºï¼š</strong>åœ¨é™æ€éƒ¨ç½²ç¯å¢ƒä¸‹ï¼Œç³»ç»Ÿä¼šä½¿ç”¨æœ¬åœ°æ¨¡æ‹ŸåŠŸèƒ½
                `;
                
                setTimeout(() => {
                    statusElement.textContent = 'ç‚¹å‡»"å¼€å§‹"æŒ‰é’®å¼€å§‹è¯­éŸ³è¾“å…¥';
                    statusElement.className = 'voice-status';
                }, 3000);
            }
        }

        async function convertAudioForBaiduAPI(audioBlob) {
            try {
                // åˆ›å»ºAudioContextï¼Œä½¿ç”¨16kHzé‡‡æ ·ç‡
                const audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: 16000
                });
                
                // è¯»å–éŸ³é¢‘æ•°æ®
                const arrayBuffer = await audioBlob.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                // è·å–éŸ³é¢‘æ•°æ®
                const channelData = audioBuffer.getChannelData(0); // å•å£°é“
                
                // å¦‚æœé‡‡æ ·ç‡ä¸æ˜¯16kHzï¼Œéœ€è¦é‡é‡‡æ ·
                let processedData = channelData;
                if (audioBuffer.sampleRate !== 16000) {
                    const ratio = 16000 / audioBuffer.sampleRate;
                    const newLength = Math.round(channelData.length * ratio);
                    processedData = new Float32Array(newLength);
                    
                    for (let i = 0; i < newLength; i++) {
                        const oldIndex = Math.floor(i / ratio);
                        processedData[i] = channelData[oldIndex];
                    }
                }
                
                // è½¬æ¢ä¸º16ä½PCMæ ¼å¼
                const pcmData = new Int16Array(processedData.length);
                for (let i = 0; i < processedData.length; i++) {
                    pcmData[i] = Math.max(-32768, Math.min(32767, processedData[i] * 32768));
                }
                
                // åˆ›å»ºæ–°çš„Blob
                return new Blob([pcmData.buffer], { type: 'audio/pcm' });
            } catch (error) {
                console.error('éŸ³é¢‘è½¬æ¢å¤±è´¥:', error);
                // å¦‚æœè½¬æ¢å¤±è´¥ï¼Œè¿”å›åŸå§‹éŸ³é¢‘
                return audioBlob;
            }
        }

        function parseIngredientsFromText(text) {
            const ingredients = [];
            const foundIngredients = new Set(); // ç”¨äºå»é‡
            
            // æ•°å­—æ˜ å°„
            const numberMap = {
                'ä¸€': 1, 'äºŒ': 2, 'ä¸¤': 2, 'ä¸‰': 3, 'å››': 4, 'äº”': 5,
                'å…­': 6, 'ä¸ƒ': 7, 'å…«': 8, 'ä¹': 9, 'å': 10,
                'åä¸€': 11, 'åäºŒ': 12, 'åä¸‰': 13, 'åå››': 14, 'åäº”': 15,
                'åå…­': 16, 'åä¸ƒ': 17, 'åå…«': 18, 'åä¹': 19, 'äºŒå': 20
            };
            
            // é£ŸæåŒä¹‰è¯æ˜ å°„è¡¨ - å°†åŒä¹‰è¯ç»Ÿä¸€ä¸ºæ ‡å‡†åç§°
            const ingredientSynonyms = {
                'è¥¿çº¢æŸ¿': 'ç•ªèŒ„',
                'ç•ªèŒ„': 'ç•ªèŒ„',
                'é»„ç“œ': 'é»„ç“œ',
                'åœŸè±†': 'åœŸè±†',
                'é©¬é“ƒè–¯': 'åœŸè±†',
                'èƒ¡èåœ': 'èƒ¡èåœ',
                'æ´‹è‘±': 'æ´‹è‘±',
                'å¤§è’œ': 'å¤§è’œ',
                'è’œ': 'å¤§è’œ',
                'å§œ': 'å§œ',
                'ç”Ÿå§œ': 'å§œ',
                'è‘±': 'è‘±',
                'å¤§è‘±': 'è‘±',
                'ç™½èœ': 'ç™½èœ',
                'è èœ': 'è èœ',
                'èŠ¹èœ': 'èŠ¹èœ',
                'éŸ­èœ': 'éŸ­èœ',
                'é¦™èœ': 'é¦™èœ',
                'è¾£æ¤’': 'è¾£æ¤’',
                'èŒ„å­': 'èŒ„å­',
                'å—ç“œ': 'å—ç“œ',
                'å†¬ç“œ': 'å†¬ç“œ',
                'è±†è…': 'è±†è…',
                'è±†èŠ½': 'è±†èŠ½',
                'è±†å¹²': 'è±†å¹²',
                'è…ç«¹': 'è…ç«¹',
                'ç²‰ä¸': 'ç²‰ä¸',
                'é¢æ¡': 'é¢æ¡',
                'ç±³é¥­': 'ç±³é¥­',
                'é¦’å¤´': 'é¦’å¤´',
                'åŒ…å­': 'åŒ…å­',
                'é¸¡è›‹': 'é¸¡è›‹',
                'é¸­è›‹': 'é¸­è›‹',
                'é¹Œé¹‘è›‹': 'é¹Œé¹‘è›‹',
                'é¸¡è‚‰': 'é¸¡è‚‰',
                'çŒªè‚‰': 'çŒªè‚‰',
                'ç‰›è‚‰': 'ç‰›è‚‰',
                'ç¾Šè‚‰': 'ç¾Šè‚‰',
                'é±¼è‚‰': 'é±¼è‚‰',
                'è™¾': 'è™¾',
                'ç”ŸæŠ½': 'ç”ŸæŠ½',
                'è€æŠ½': 'è€æŠ½',
                'èšæ²¹': 'èšæ²¹',
                'é†‹': 'é†‹',
                'ç›': 'ç›',
                'ç³–': 'ç³–',
                'å‘³ç²¾': 'å‘³ç²¾',
                'é¸¡ç²¾': 'é¸¡ç²¾',
                'èƒ¡æ¤’ç²‰': 'èƒ¡æ¤’ç²‰',
                'èŠ±æ¤’': 'èŠ±æ¤’',
                'å…«è§’': 'å…«è§’',
                'æ¡‚çš®': 'æ¡‚çš®',
                'é¦™å¶': 'é¦™å¶',
                'å­œç„¶': 'å­œç„¶',
                'èŠéº»': 'èŠéº»',
                'èŠ±ç”Ÿ': 'èŠ±ç”Ÿ',
                'æ ¸æ¡ƒ': 'æ ¸æ¡ƒ',
                'æä»': 'æä»'
            };
            
            // å¸¸è§é£Ÿæå…³é”®è¯ï¼ˆä½¿ç”¨æ ‡å‡†åç§°ï¼‰
            const ingredientKeywords = Object.values(ingredientSynonyms);
            
            // å…ˆç”¨é€—å·ï¼ˆä¸­è‹±æ–‡ï¼‰ã€é¡¿å·ã€å¥å·ã€åˆ†å·ç­‰åˆ†å‰²å¥å­ï¼Œæå‡å¤šé£Ÿæè¯†åˆ«ç‡
            const segments = text.split(/[ï¼Œ,ã€ã€‚ï¼›;\n]/);
            
            // åŒ¹é…æ¨¡å¼ï¼šæ•°å­— + å•ä½ + é£Ÿæ
            const patterns = [
                // åŒ¹é… "ä¸‰ä¸ªè¥¿çº¢æŸ¿" è¿™ç§æ ¼å¼
                new RegExp(`([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åä¸¤]+ä¸ª|\\d+ä¸ª)([^ï¼Œã€‚ï¼ï¼Ÿã€,;ï¼›\s]+)`),
                // åŒ¹é… "ä¸‰ä¸ª è¥¿çº¢æŸ¿" è¿™ç§æ ¼å¼ï¼ˆå¸¦ç©ºæ ¼ï¼‰
                new RegExp(`([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åä¸¤]+ä¸ª|\\d+ä¸ª)\\s*([^ï¼Œã€‚ï¼ï¼Ÿã€,;ï¼›\s]+)`),
                // åŒ¹é… "ä¸‰ ä¸ª è¥¿çº¢æŸ¿" è¿™ç§æ ¼å¼ï¼ˆåˆ†å¼€ï¼‰
                new RegExp(`([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åä¸¤]+)\\s*ä¸ª\\s*([^ï¼Œã€‚ï¼ï¼Ÿã€,;ï¼›\s]+)`),
                // åŒ¹é… "3ä¸ªè¥¿çº¢æŸ¿" è¿™ç§æ ¼å¼
                new RegExp(`(\\d+)\\s*ä¸ª\\s*([^ï¼Œã€‚ï¼ï¼Ÿã€,;ï¼›\s]+)`),
                // åŒ¹é… "ä¸¤åŒ…é¢æ¡" è¿™ç§æ ¼å¼
                new RegExp(`([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åä¸¤]+åŒ…|\\d+åŒ…)([^ï¼Œã€‚ï¼ï¼Ÿã€,;ï¼›\s]+)`),
                // åŒ¹é… "ä¸¤åŒ… é¢æ¡" è¿™ç§æ ¼å¼ï¼ˆå¸¦ç©ºæ ¼ï¼‰
                new RegExp(`([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åä¸¤]+åŒ…|\\d+åŒ…)\\s*([^ï¼Œã€‚ï¼ï¼Ÿã€,;ï¼›\s]+)`),
                // åŒ¹é… "ä¸¤ åŒ… é¢æ¡" è¿™ç§æ ¼å¼ï¼ˆåˆ†å¼€ï¼‰
                new RegExp(`([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åä¸¤]+)\\s*åŒ…\\s*([^ï¼Œã€‚ï¼ï¼Ÿã€,;ï¼›\s]+)`),
                // åŒ¹é… "2åŒ…é¢æ¡" è¿™ç§æ ¼å¼
                new RegExp(`(\\d+)\\s*åŒ…\\s*([^ï¼Œã€‚ï¼ï¼Ÿã€,;ï¼›\s]+)`),
                // åŒ¹é… "ä¸¤æ ¹é»„ç“œ" è¿™ç§æ ¼å¼
                new RegExp(`([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åä¸¤]+æ ¹|\\d+æ ¹)([^ï¼Œã€‚ï¼ï¼Ÿã€,;ï¼›\s]+)`),
                // åŒ¹é… "ä¸¤æ ¹ é»„ç“œ" è¿™ç§æ ¼å¼ï¼ˆå¸¦ç©ºæ ¼ï¼‰
                new RegExp(`([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åä¸¤]+æ ¹|\\d+æ ¹)\\s*([^ï¼Œã€‚ï¼ï¼Ÿã€,;ï¼›\s]+)`),
                // åŒ¹é… "ä¸¤ æ ¹ é»„ç“œ" è¿™ç§æ ¼å¼ï¼ˆåˆ†å¼€ï¼‰
                new RegExp(`([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åä¸¤]+)\\s*æ ¹\\s*([^ï¼Œã€‚ï¼ï¼Ÿã€,;ï¼›\s]+)`),
                // åŒ¹é… "2æ ¹é»„ç“œ" è¿™ç§æ ¼å¼
                new RegExp(`(\\d+)\\s*æ ¹\\s*([^ï¼Œã€‚ï¼ï¼Ÿã€,;ï¼›\s]+)`),
                // åŒ¹é… "ä¸‰ è¥¿çº¢æŸ¿" è¿™ç§æ ¼å¼ï¼ˆçœç•¥å•ä½ï¼‰
                new RegExp(`([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+)\\s+([^ï¼Œã€‚ï¼ï¼Ÿã€,;ï¼›\s]+)`),
                // åŒ¹é… "3 è¥¿çº¢æŸ¿" è¿™ç§æ ¼å¼ï¼ˆçœç•¥å•ä½ï¼‰
                new RegExp(`(\\d+)\\s+([^ï¼Œã€‚ï¼ï¼Ÿã€,;ï¼›\s]+)`)
            ];
            
            // é€æ®µåŒ¹é…ï¼Œæå‡å¤šé£Ÿæè¯†åˆ«ç‡
            segments.forEach(segment => {
                let matched = false;
                for (const pattern of patterns) {
                    const match = pattern.exec(segment.trim());
                    if (match) {
                        matched = true;
                        const quantityPart = match[1];
                        const ingredient = match[2];
                        let num = 1;
                        let unit = 'ä¸ª';
                        if (numberMap[quantityPart]) {
                            num = numberMap[quantityPart];
                        } else if (quantityPart.includes('ä¸ª')) {
                            const numStr = quantityPart.replace('ä¸ª', '');
                            num = numberMap[numStr] || parseInt(numStr) || 1;
                            unit = 'ä¸ª';
                        } else if (quantityPart.includes('åŒ…')) {
                            const numStr = quantityPart.replace('åŒ…', '');
                            num = numberMap[numStr] || parseInt(numStr) || 1;
                            unit = 'åŒ…';
                        } else if (quantityPart.includes('æ ¹')) {
                            const numStr = quantityPart.replace('æ ¹', '');
                            num = numberMap[numStr] || parseInt(numStr) || 1;
                            unit = 'æ ¹';
                        } else {
                            num = numberMap[quantityPart] || parseInt(quantityPart) || 1;
                            unit = 'ä¸ª';
                        }
                        if (isNaN(num)) num = 1;
                        // æ ‡å‡†åŒ–é£Ÿæåç§°
                        let normalizedIngredient = ingredient;
                        for (const [synonym, standardName] of Object.entries(ingredientSynonyms)) {
                            if (ingredient.includes(synonym) || synonym.includes(ingredient)) {
                                normalizedIngredient = standardName;
                                break;
                            }
                        }
                        if (ingredientKeywords.includes(normalizedIngredient) && !foundIngredients.has(normalizedIngredient)) {
                            ingredients.push({
                                name: normalizedIngredient,
                                quantity: `${num}${unit}`
                            });
                            foundIngredients.add(normalizedIngredient);
                        }
                        break; // å½“å‰æ®µåªå–ç¬¬ä¸€ä¸ªåŒ¹é…ï¼Œé˜²æ­¢é‡å¤
                    }
                }
                // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°æ•°é‡ï¼Œå°è¯•åŒ¹é…å•ç‹¬çš„é£Ÿæåç§°ï¼ˆä¸breakï¼Œå…¨éƒ¨éå†ï¼‰
                if (!matched) {
                    for (const [synonym, standardName] of Object.entries(ingredientSynonyms)) {
                        if (segment.includes(synonym) && !foundIngredients.has(standardName)) {
                            ingredients.push({
                                name: standardName,
                                quantity: '1ä¸ª'
                            });
                            foundIngredients.add(standardName);
                        }
                    }
                }
            });
            return ingredients;
        }

        // æ ‡å‡†åŒ–é£Ÿæåç§°å‡½æ•°
        function normalizeIngredientName(ingredientName) {
            // é£ŸæåŒä¹‰è¯æ˜ å°„è¡¨ - å°†åŒä¹‰è¯ç»Ÿä¸€ä¸ºæ ‡å‡†åç§°
            const ingredientSynonyms = {
                'è¥¿çº¢æŸ¿': 'ç•ªèŒ„',
                'ç•ªèŒ„': 'ç•ªèŒ„',
                'é»„ç“œ': 'é»„ç“œ',
                'åœŸè±†': 'åœŸè±†',
                'é©¬é“ƒè–¯': 'åœŸè±†',
                'èƒ¡èåœ': 'èƒ¡èåœ',
                'æ´‹è‘±': 'æ´‹è‘±',
                'å¤§è’œ': 'å¤§è’œ',
                'è’œ': 'å¤§è’œ',
                'å§œ': 'å§œ',
                'ç”Ÿå§œ': 'å§œ',
                'è‘±': 'è‘±',
                'å¤§è‘±': 'è‘±',
                'ç™½èœ': 'ç™½èœ',
                'è èœ': 'è èœ',
                'èŠ¹èœ': 'èŠ¹èœ',
                'éŸ­èœ': 'éŸ­èœ',
                'é¦™èœ': 'é¦™èœ',
                'è¾£æ¤’': 'è¾£æ¤’',
                'èŒ„å­': 'èŒ„å­',
                'å—ç“œ': 'å—ç“œ',
                'å†¬ç“œ': 'å†¬ç“œ',
                'è±†è…': 'è±†è…',
                'è±†èŠ½': 'è±†èŠ½',
                'è±†å¹²': 'è±†å¹²',
                'è…ç«¹': 'è…ç«¹',
                'ç²‰ä¸': 'ç²‰ä¸',
                'é¢æ¡': 'é¢æ¡',
                'ç±³é¥­': 'ç±³é¥­',
                'é¦’å¤´': 'é¦’å¤´',
                'åŒ…å­': 'åŒ…å­',
                'é¸¡è›‹': 'é¸¡è›‹',
                'é¸­è›‹': 'é¸­è›‹',
                'é¹Œé¹‘è›‹': 'é¹Œé¹‘è›‹',
                'é¸¡è‚‰': 'é¸¡è‚‰',
                'çŒªè‚‰': 'çŒªè‚‰',
                'ç‰›è‚‰': 'ç‰›è‚‰',
                'ç¾Šè‚‰': 'ç¾Šè‚‰',
                'é±¼è‚‰': 'é±¼è‚‰',
                'è™¾': 'è™¾',
                'ç”ŸæŠ½': 'ç”ŸæŠ½',
                'è€æŠ½': 'è€æŠ½',
                'èšæ²¹': 'èšæ²¹',
                'é†‹': 'é†‹',
                'ç›': 'ç›',
                'ç³–': 'ç³–',
                'å‘³ç²¾': 'å‘³ç²¾',
                'é¸¡ç²¾': 'é¸¡ç²¾',
                'èƒ¡æ¤’ç²‰': 'èƒ¡æ¤’ç²‰',
                'èŠ±æ¤’': 'èŠ±æ¤’',
                'å…«è§’': 'å…«è§’',
                'æ¡‚çš®': 'æ¡‚çš®',
                'é¦™å¶': 'é¦™å¶',
                'å­œç„¶': 'å­œç„¶',
                'èŠéº»': 'èŠéº»',
                'èŠ±ç”Ÿ': 'èŠ±ç”Ÿ',
                'æ ¸æ¡ƒ': 'æ ¸æ¡ƒ',
                'æä»': 'æä»'
            };
            
            // æŸ¥æ‰¾åŒä¹‰è¯æ˜ å°„
            for (const [synonym, standardName] of Object.entries(ingredientSynonyms)) {
                if (ingredientName === synonym || ingredientName.includes(synonym) || synonym.includes(ingredientName)) {
                    return standardName;
                }
            }
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ˜ å°„ï¼Œè¿”å›åŸåç§°
            return ingredientName;
        }

        // æµ‹è¯•å‡½æ•°ï¼šéªŒè¯åŒä¹‰è¯æ˜ å°„
        function testIngredientSynonyms() {
            console.log('æµ‹è¯•åŒä¹‰è¯æ˜ å°„åŠŸèƒ½ï¼š');
            
            const testCases = [
                'ä¸‰ä¸ªè¥¿çº¢æŸ¿',
                'ä¸¤ä¸ªç•ªèŒ„',
                'ä¸€æ ¹é»„ç“œ',
                'ä¸¤æ ¹é»„ç“œ',
                'ä¸¤ä¸ªé©¬é“ƒè–¯',
                'ä¸‰ç“£è’œ',
                'ä¸€å—ç”Ÿå§œ',
                'æˆ‘ä¹°äº†ä¸€ä¸ªè‹¹æœï¼Œä¸¤ä¸ªé¦™è•‰'
            ];
            
            testCases.forEach(testCase => {
                const result = parseIngredientsFromText(testCase);
                console.log(`è¾“å…¥: "${testCase}" -> è¾“å‡º:`, result);
            });
            
            console.log('æµ‹è¯•æ ‡å‡†åŒ–å‡½æ•°ï¼š');
            const normalizeTests = ['è¥¿çº¢æŸ¿', 'ç•ªèŒ„', 'é©¬é“ƒè–¯', 'è’œ', 'ç”Ÿå§œ'];
            normalizeTests.forEach(test => {
                console.log(`æ ‡å‡†åŒ– "${test}" -> "${normalizeIngredientName(test)}"`);
            });
        }

        // æµ‹è¯•å‡½æ•°
        function runTest() {
            const testInput = document.getElementById('testInput').value;
            const testResult = document.getElementById('testResult');
            
            if (!testInput.trim()) {
                testResult.innerHTML = '<strong>è¯·è¾“å…¥æµ‹è¯•æ–‡æœ¬</strong>';
                return;
            }
            
            const result = parseIngredientsFromText(testInput);
            testResult.innerHTML = `
                <strong>æµ‹è¯•ç»“æœï¼š</strong><br>
                è¾“å…¥: "${testInput}"<br>
                è§£æç»“æœ: ${result.map(item => `${item.name}ï¼š${item.quantity}`).join('ã€')}<br>
                æ ‡å‡†åŒ–åç§°: ${result.map(item => item.name).join('ã€')}
            `;
        }

        // æµ‹è¯•æ¸…ç©ºåŠŸèƒ½
        async function testClearAll() {
            const testResult = document.getElementById('testResult');
            testResult.innerHTML = '<strong>æµ‹è¯•æ¸…ç©ºåŠŸèƒ½ï¼š</strong><br>';
            
            try {
                // å…ˆæ·»åŠ ä¸€äº›æµ‹è¯•æ•°æ®
                testResult.innerHTML += '1. æ·»åŠ æµ‹è¯•é£Ÿæ...<br>';
                await api.addUserIngredients(['æµ‹è¯•é£Ÿæ1', 'æµ‹è¯•é£Ÿæ2', 'æµ‹è¯•é£Ÿæ3']);
                
                // è·å–å½“å‰é£Ÿæ
                testResult.innerHTML += '2. è·å–å½“å‰é£Ÿæ...<br>';
                const currentIngredients = await api.getUserIngredients();
                testResult.innerHTML += `å½“å‰é£Ÿææ•°é‡: ${currentIngredients.length}<br>`;
                
                // æ¸…ç©ºæ‰€æœ‰é£Ÿæ
                testResult.innerHTML += '3. æ¸…ç©ºæ‰€æœ‰é£Ÿæ...<br>';
                await api.clearAllUserIngredients();
                
                // éªŒè¯æ¸…ç©ºç»“æœ
                testResult.innerHTML += '4. éªŒè¯æ¸…ç©ºç»“æœ...<br>';
                const clearedIngredients = await api.getUserIngredients();
                testResult.innerHTML += `æ¸…ç©ºåé£Ÿææ•°é‡: ${clearedIngredients.length}<br>`;
                
                testResult.innerHTML += '<strong style="color: green;">âœ… æ¸…ç©ºåŠŸèƒ½æµ‹è¯•æˆåŠŸï¼</strong>';
                
            } catch (error) {
                testResult.innerHTML += `<strong style="color: red;">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</strong>`;
                console.error('æµ‹è¯•æ¸…ç©ºåŠŸèƒ½å¤±è´¥:', error);
            }
        }

        // æµ‹è¯•æœ¬åœ°è¯­éŸ³è¯†åˆ«åŠŸèƒ½
        async function testLocalVoiceRecognition() {
            const resultElement = document.getElementById('localVoiceTestResult');
            resultElement.innerHTML = '<strong>æ­£åœ¨æµ‹è¯•æœ¬åœ°è¯­éŸ³è¯†åˆ«...</strong>';
            
            try {
                // è°ƒç”¨æœ¬åœ°è¯­éŸ³è¯†åˆ«æ¨¡æ‹Ÿ
                const result = await api.simulateVoiceRecognition();
                
                if (result.error) {
                    resultElement.innerHTML = `<strong>æµ‹è¯•å¤±è´¥ï¼š</strong>${result.error}`;
                    return;
                }
                
                const recognizedText = result.text;
                
                // è§£æé£Ÿæå’Œæ•°é‡
                const parsedIngredients = parseIngredientsFromText(recognizedText);
                
                // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
                resultElement.innerHTML = `
                    <strong>âœ… æœ¬åœ°è¯­éŸ³è¯†åˆ«æµ‹è¯•æˆåŠŸï¼</strong><br><br>
                    <strong>æ¨¡æ‹Ÿè¯†åˆ«ç»“æœï¼š</strong>${recognizedText}<br><br>
                    <strong>è§£æç»“æœï¼š</strong><br>
                    ${parsedIngredients.map(item => `${item.name}ï¼š${item.quantity}`).join('ã€')}<br><br>
                    <strong>æ•°æ®æ¥æºï¼š</strong>${result.source}<br><br>
                    <em>ğŸ’¡ åœ¨é™æ€éƒ¨ç½²ç¯å¢ƒä¸‹ï¼Œè¯­éŸ³è¯†åˆ«åŠŸèƒ½ä¼šä½¿ç”¨è¿™ç§æœ¬åœ°æ¨¡æ‹Ÿæ–¹å¼ï¼Œç¡®ä¿åŠŸèƒ½å¯ç”¨ã€‚</em>
                `;
                
                // è‡ªåŠ¨æ·»åŠ åˆ°ä»“åº“
                parsedIngredients.forEach(item => {
                    const ingredientName = item.name;
                    if (!selectedIngredients.includes(ingredientName)) {
                        selectedIngredients.push(ingredientName);
                    }
                    
                    // ç´¯åŠ æ•°é‡
                    const currentQuantity = ingredientQuantities[ingredientName] || '0ä¸ª';
                    const newQuantity = item.quantity;
                    
                    const currentNum = parseInt(currentQuantity.match(/\d+/)[0]) || 0;
                    const newNum = parseInt(newQuantity.match(/\d+/)[0]) || 0;
                    
                    let unit = 'ä¸ª';
                    const unitMatch = newQuantity.match(/[ä¸ªåŒ…æ ¹ç“¶è¢‹æ–¤å…‹åƒå…‹å…¬æ–¤ç‰‡ç“£æŠŠæŸç›’]/);
                    if (unitMatch) {
                        unit = unitMatch[0];
                    } else {
                        const currentUnitMatch = currentQuantity.match(/[ä¸ªåŒ…æ ¹ç“¶è¢‹æ–¤å…‹åƒå…‹å…¬æ–¤ç‰‡ç“£æŠŠæŸç›’]/);
                        if (currentUnitMatch) {
                            unit = currentUnitMatch[0];
                        }
                    }
                    
                    const totalNum = currentNum + newNum;
                    ingredientQuantities[ingredientName] = `${totalNum}${unit}`;
                });
                
                updateWarehouseDisplay();
                saveToLocalStorage();
                
            } catch (error) {
                resultElement.innerHTML = `<strong>âŒ æµ‹è¯•å¤±è´¥ï¼š</strong>${error.message}`;
            }
        }
        
        // æ¸…ç©ºè¯­éŸ³æµ‹è¯•ç»“æœ
        function clearVoiceTestResult() {
            document.getElementById('localVoiceTestResult').innerHTML = '';
        }
        
        // é¡µé¢åŠ è½½æ—¶è¿è¡Œæµ‹è¯•ï¼ˆä»…åœ¨å¼€å‘ç¯å¢ƒï¼‰
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            setTimeout(() => {
                testIngredientSynonyms();
                document.getElementById('testArea').style.display = 'block';
            }, 1000);
        }
        
        // åœ¨é™æ€éƒ¨ç½²ç¯å¢ƒä¸‹æ˜¾ç¤ºæœ¬åœ°è¯­éŸ³è¯†åˆ«æµ‹è¯•åŒºåŸŸ
        if (window.location.hostname === 'www.forbites.store' || window.location.hostname === 'forbites.store') {
            setTimeout(() => {
                document.getElementById('localVoiceTest').style.display = 'block';
            }, 1000);
        }

        function updateWarehouseDisplay() {
            const warehouseContent = document.getElementById('warehouseContent');
            
            if (selectedIngredients.length === 0) {
                warehouseContent.textContent = 'æ‚¨è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•è°ƒæ–™ï¼Œè¯·é€‰æ‹©å¸¸ç”¨è°ƒæ–™æˆ–ä½¿ç”¨è¯­éŸ³è¾“å…¥åŠŸèƒ½';
            } else {
                warehouseContent.innerHTML = `
                    <strong>å½“å‰æ‹¥æœ‰ï¼š</strong>
                    <br>
                    ${selectedIngredients.map(ingredient => {
                        const quantity = ingredientQuantities[ingredient] || '1ä¸ª';
                        return `${ingredient}ï¼š${quantity}`;
                    }).join('ã€')}
                    <br><br>
                    <small>å…± ${selectedIngredients.length} ç§è°ƒæ–™å’Œé£Ÿæ</small>
                `;
            }
        }

        // åŠ è½½ä¿å­˜çš„é£Ÿæ
        async function loadSavedIngredients() {
            try {
                const savedIngredients = await api.getUserIngredients();
                selectedIngredients = savedIngredients.map(item => item.name);
                
                // æ¢å¤æ•°é‡ä¿¡æ¯ï¼ˆä»æ•°æ®åº“åŠ è½½çš„é»˜è®¤ä¸º1ä¸ªï¼‰
                selectedIngredients.forEach(ingredient => {
                    ingredientQuantities[ingredient] = '1ä¸ª';
                });
                
                updateWarehouseDisplay();
                // ä¸å†è‡ªåŠ¨é«˜äº®é¡¶éƒ¨æŒ‰é’®ï¼Œä¿æŒæ‰€æœ‰æŒ‰é’®æœªé€‰ä¸­
            } catch (error) {
                console.error('åŠ è½½ä¿å­˜çš„é£Ÿæå¤±è´¥:', error);
            }
        }

        // ä¿å­˜é£Ÿæåˆ°æ•°æ®åº“
        async function saveToLocalStorage() {
            try {
                await api.addUserIngredients(selectedIngredients);
            } catch (error) {
                console.error('ä¿å­˜é£Ÿæå¤±è´¥:', error);
            }
        }

        // æ¸…é™¤æ‰€æœ‰é£Ÿæ
        async function clearAllIngredients() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºä»“åº“ä¸­çš„æ‰€æœ‰é£Ÿæå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                try {
                    // æ¸…é™¤å‰ç«¯æ•°æ®
                    selectedIngredients = [];
                    ingredientQuantities = {};
                    
                    // æ¸…é™¤æ•°æ®åº“ä¸­çš„æ•°æ®
                    await api.clearAllUserIngredients();
                    
                    // æ›´æ–°æ˜¾ç¤º
                    updateWarehouseDisplay();
                    
                    // æ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('.ingredient-item.selected').forEach(item => {
                        item.classList.remove('selected');
                    });
                    
                    alert('ä»“åº“å·²æ¸…ç©ºï¼');
                } catch (error) {
                    console.error('æ¸…ç©ºé£Ÿæå¤±è´¥:', error);
                    alert('æ¸…ç©ºå¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            }
        }
    </script>
</body>
</html>